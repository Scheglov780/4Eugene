CKEDITOR.dialog.add("base64imageDialog",function(D){function g(a){if("string"!=typeof a||!a){B.getElement().setHtml("")}else{var c=new Image;B.getElement().setHtml("Loading...");c.onload=function(){B.getElement().setHtml("");null==z||null==A?(C.setValueOf("tab-properties","width",this.width),C.setValueOf("tab-properties","height",this.height),y=1,0<this.height&&0<this.width&&(y=this.width/this.height),0>=y&&(y=1)):A=z=null;this.id=D.id+"previewimage";this.setAttribute("style","max-width:400px;max-height:100px;");this.setAttribute("alt","");try{var d=B.getElement().$;d&&d.appendChild(this)}catch(e){}};c.onerror=function(){B.getElement().setHtml("")};c.onabort=function(){B.getElement().setHtml("")};c.src=a}}function v(c){B.getElement().setHtml("");if("base64"==c){x&&x.setValue(!1,!0),w&&w.setValue(!1,!0)}else{if("url"==c){x&&x.setValue(!0,!0),w&&w.setValue(!1,!0),f&&g(f.getValue())}else{if(b){x&&x.setValue(!1,!0);w&&w.setValue(!0,!0);var e=C.getContentElement("tab-source","file"),c=null;try{c=e.getInputElement().$}catch(d){c=null}if(c&&("files" in c&&c.files&&0<c.files.length&&c.files[0])&&(!("type" in c.files[0])||c.files[0].type.match("image.*"))&&FileReader){B.getElement().setHtml("Loading..."),e=new FileReader,e.onload=function(){return function(a){B.getElement().setHtml("");g(a.target.result)}}(c.files[0]),e.onerror=function(){B.getElement().setHtml("")},e.onabort=function(){B.getElement().setHtml("")},e.readAsDataURL(c.files[0])}}}}}function H(d){var j=C.getContentElement("tab-properties","width").getValue(),h=C.getContentElement("tab-properties","height").getValue(),m="px",i="px";0<=j.indexOf("%")&&(m="%");0<=h.indexOf("%")&&(i="%");j=parseInt(j,10);h=parseInt(h,10);isNaN(j)&&(j=0);isNaN(h)&&(h=0);var l="px";"width"==d?("%"==m&&(l="%"),h=Math.round(j/y)):("%"==i&&(l="%"),j=Math.round(h*y));"%"==l&&(j+="%",h+="%");C.getContentElement("tab-properties","width").setValue(j);C.getContentElement("tab-properties","height").setValue(h)}function G(d){var e=d.getValue(),h="";0<=e.indexOf("%")&&(h="%");e=parseInt(e,10);isNaN(e)&&(e=0);d.setValue(e+h)}var C=null,E=null,z=null,A=null,B=null,x=null,f=null,w=null,y=1,k=!0,b=function(){var e=!1,i=null;try{FileReader&&(i=document.createElement("input"))&&"files" in i&&(e=!0)}catch(h){e=!1}return e}(),F=b?[{type:"hbox",widths:["70px"],children:[{type:"checkbox",id:"urlcheckbox",style:"margin-top:5px",label:D.lang.common.url+":"},{type:"text",id:"url",label:"",onChange:function(){v("url")}}]},{type:"hbox",widths:["70px"],children:[{type:"checkbox",id:"filecheckbox",style:"margin-top:5px",label:D.lang.common.upload+":"},{type:"file",id:"file",label:"",onChange:function(){v("file")}}]},{type:"html",id:"preview",html:(new CKEDITOR.template('<div style="text-align:center;"></div>')).output()}]:[{type:"text",id:"url",label:D.lang.common.url,onChange:function(){v("url")}},{type:"html",id:"preview",html:(new CKEDITOR.template('<div style="text-align:center;"></div>')).output()}];return{title:D.lang.common.image,minWidth:450,minHeight:180,onLoad:function(){b&&(x=this.getContentElement("tab-source","urlcheckbox"),w=this.getContentElement("tab-source","filecheckbox"),x.getInputElement().on("click",function(){v("url")}),w.getInputElement().on("click",function(){v("file")}));f=this.getContentElement("tab-source","url");B=this.getContentElement("tab-source","preview");this.getContentElement("tab-properties","lock").getInputElement().on("click",function(){(k=this.getValue()?true:false)&&H("width")},this.getContentElement("tab-properties","lock"));this.getContentElement("tab-properties","width").getInputElement().on("keyup",function(){k&&H("width")});this.getContentElement("tab-properties","height").getInputElement().on("keyup",function(){k&&H("height")});this.getContentElement("tab-properties","vmargin").getInputElement().on("keyup",function(){G(this)},this.getContentElement("tab-properties","vmargin"));this.getContentElement("tab-properties","hmargin").getInputElement().on("keyup",function(){G(this)},this.getContentElement("tab-properties","hmargin"));this.getContentElement("tab-properties","border").getInputElement().on("keyup",function(){G(this)},this.getContentElement("tab-properties","border"))},onShow:function(){B.getElement().setHtml("");C=this;A=z=null;y=1;k=!0;(E=D.getSelection())&&(E=E.getSelectedElement());if(!E||"img"!==E.getName()){E=null}C.setValueOf("tab-properties","lock",k);C.setValueOf("tab-properties","vmargin","0");C.setValueOf("tab-properties","hmargin","0");C.setValueOf("tab-properties","border","0");C.setValueOf("tab-properties","align","none");if(E){"string"==typeof E.getAttribute("width")&&(z=E.getAttribute("width"));"string"==typeof E.getAttribute("height")&&(A=E.getAttribute("height"));if((null==z||null==A)&&E.$){z=E.$.width,A=E.$.height}null!=z&&null!=A&&(C.setValueOf("tab-properties","width",z),C.setValueOf("tab-properties","height",A),z=parseInt(z,10),A=parseInt(A,10),y=1,!isNaN(z)&&(!isNaN(A)&&0<A&&0<z)&&(y=z/A),0>=y&&(y=1));"string"==typeof E.getAttribute("src")&&(0===E.getAttribute("src").indexOf("data:")?(v("base64"),g(E.getAttribute("src"))):C.setValueOf("tab-source","url",E.getAttribute("src")));"string"==typeof E.getAttribute("alt")&&C.setValueOf("tab-properties","alt",E.getAttribute("alt"));"string"==typeof E.getAttribute("hspace")&&C.setValueOf("tab-properties","hmargin",E.getAttribute("hspace"));"string"==typeof E.getAttribute("vspace")&&C.setValueOf("tab-properties","vmargin",E.getAttribute("vspace"));"string"==typeof E.getAttribute("border")&&C.setValueOf("tab-properties","border",E.getAttribute("border"));if("string"==typeof E.getAttribute("align")){switch(E.getAttribute("align")){case"top":case"text-top":C.setValueOf("tab-properties","align","top");break;case"baseline":case"bottom":case"text-bottom":C.setValueOf("tab-properties","align","bottom");break;case"left":C.setValueOf("tab-properties","align","left");break;case"right":C.setValueOf("tab-properties","align","right")}}C.selectPage("tab-properties")}},onOk:function(){var a="";try{a=CKEDITOR.document.getById(D.id+"previewimage").$.src}catch(o){a=""}if(!("string"!=typeof a||null==a||""===a)){var p=E?E:D.document.createElement("img");p.setAttribute("src",a);p.setAttribute("alt",C.getValueOf("tab-properties","alt").replace(/^\s+/,"").replace(/\s+$/,""));var a={width:["width","width:#;","integer",1],height:["height","height:#;","integer",1],vmargin:["vspace","margin-top:#;margin-bottom:#;","integer",0],hmargin:["hspace","margin-left:#;margin-right:#;","integer",0],align:["align",""],border:["border","border:# solid black;","integer",0]},l=[],n,m,d,c;for(c in a){m=d=n=C.getValueOf("tab-properties",c);unit="px";if("align"==c){switch(n){case"top":case"bottom":a[c][1]="vertical-align:#;";break;case"left":case"right":a[c][1]="float:#;";break;default:n=null}}"integer"==a[c][2]&&(0<=n.indexOf("%")&&(unit="%"),n=parseInt(n,10),isNaN(n)?n=null:n<a[c][3]&&(n=null),null!=n&&("%"==unit?(d=n+"%",m=n+"%"):(d=n,m=n+"px")));null!=n&&(p.setAttribute(a[c][0],d),l.push(a[c][1].replace(/#/g,m)))}0<l.length&&p.setAttribute("style",l.join(""));E||D.insertElement(p);D.plugins.imageresize&&D.plugins.imageresize.resize(D,p,800,800)}},contents:[{id:"tab-source",label:D.lang.common.generalTab,elements:F},{id:"tab-properties",label:D.lang.common.advancedTab,elements:[{type:"text",id:"alt",label:D.lang.base64image.alt},{type:"hbox",widths:["15%","15%","70%"],children:[{type:"text",width:"45px",id:"width",label:D.lang.common.width},{type:"text",width:"45px",id:"height",label:D.lang.common.height},{type:"checkbox",id:"lock",label:D.lang.base64image.lockRatio,style:"margin-top:18px;"}]},{type:"hbox",widths:["23%","30%","30%","17%"],style:"margin-top:10px;",children:[{type:"select",id:"align",label:D.lang.common.align,items:[[D.lang.common.notSet,"none"],[D.lang.common.alignTop,"top"],[D.lang.common.alignBottom,"bottom"],[D.lang.common.alignLeft,"left"],[D.lang.common.alignRight,"right"]]},{type:"text",width:"45px",id:"vmargin",label:D.lang.base64image.vSpace},{type:"text",width:"45px",id:"hmargin",label:D.lang.base64image.hSpace},{type:"text",width:"45px",id:"border",label:D.lang.base64image.border}]}]}]}});